{% extends 'ej_conversations/base.jinja2' %}

{% block metaOG2 %}

    <meta name="description" property="og:title" content="Area de integração da EJ com outras ferramentas.">
    <meta property="og:description" content="Area de integração da EJ com outras ferramentas.">

{% endblock metaOG2 %}


{% block _menu %} {{ menu(request.user, board_palette) }} {% endblock %}

{% block content %}

<div class="tools">
	<div class="tools-container">	
    <div class="tools-section">
    <div class="tools-title">
      <h1 class="h2 text-accent">{{_("Tools")}} > {{ tool["integration"] }} > Telegram </h1>
      <span>{{_("Collect opinions using EJ's chatbot, also known as Duda. Allows you to collect the opinion of whatsapp users. To make the collection available, forward the participation link to groups, channels or directly in the user's private chat.") }}</span>
    </div>
      <div class="tools-content">
        <h3 class="h3 divider">{{_("Participation link")}}</h3>
        <span class="helptext">{{_("Share the call for participation to start the collection.")}}</span>
        <div class="tools-divider">

          <div class="tools-select">
            <label for="bot">Bot</label>
            <select name="bot" id="tools-select-bot">
              {% for channel in channels %}
                <option value={{channel[1]}}>{{channel[0]}}</option>
              {% endfor %}
            </select>
              
          </div>
          <div class="tools-share tools-cards-width">
            <div class="tools-share-container">
              <span id="tools-icon-share" class="tools-icon-share" style="background: url({{static('/img/icons/share.svg')}}) repeat;" alt="Share icon">
                <span id="tools-tip-text">{{_("Copied to clipboard!")}}</span>
              </span>
            </div>

            <div class="tools-share-content">
              <span id="helptext-tool" class="helptext">
                {{shareText}}
                {{conversation.text}}
                <a class="tools-link" id="tools-channel">https://t.me/BOT_NAME?start={{conversation.id}}</a>
              </span>
            </div>
          </div>
        </div>
    </div>   
    <p><a href="{{ conversation.url('conversation-tools:chatbot') }}" title="{{ _('Back to channels') }}"
		class="lowercase bold text-brand">
	    <i class="fa fa-chevron-left"></i>{% trans %}Back to tools{% endtrans %}
    </a></p> 
  </div>
  
</div>  

<script type="text/javascript">

const makeText = function(){
  return "{{shareText + conversation.text}}"
}

window.onload = function() {

  const btn = document.getElementById('tools-icon-share');
  const select = document.getElementById('tools-select-bot')

  const anchor = document.getElementById('tools-channel')
  anchor.text = anchor.text.replace("BOT_NAME", select.value)

  let shareData = {
    title: "{{conversation.title}}",
    text: makeText(),
    url: anchor.text
  }
  
  const copyText = async function() {
    try {
      var range = document.createRange();
      const text = document.getElementById("helptext-tool");
      const tip = document.getElementById("tools-tip-text")
      range.selectNode(text);
      window.getSelection().removeAllRanges(); // clear current selection
      window.getSelection().addRange(range); // to select text
      document.execCommand("copy");
      window.getSelection().removeAllRanges();// to deselect

      tip.classList.add('tools-tip-text-show');  

      await new Promise(r => setTimeout(r, 2000));
      tip.classList.remove('tools-tip-text-show');  
      tip.classList.add('tools-tip-text-hidde');  
    } catch(err){
      alert("Error")
    }
  }

  btn.addEventListener('click', async () => {
    try {
      await navigator.share(shareData)
    } catch (err) {
      await copyText()
    }
  });

  select.addEventListener('change', (e) => {
    const url = "https://t.me/" + e.target.value + "?start={{conversation.id}}"
    anchor.text = url
    shareData.url = url 
    shareData.text = makeText() 
  });
};

</script>

{% endblock %}