{% extends 'base.jinja2' %}

{% block metaOG2 %}

    <meta name="description" property="og:title" content="{{conversation.text}}">
    <meta property="og:description" content="Participe e dê sua opinião com comentários e votos!">

    <!-- Twitter && Telegram -->
    <meta name="twitter:title" content="{{conversation.text}}">

{% endblock metaOG2 %}

{% block _menu %} {{ menu(request.user, board_palette) }} {% endblock %}

{% block content %}
    <div class="ConversationDetail">
        {# Ballon with title #}
        {{ conversation|role('balloon') }}

        {# Current comment #}
        <div class="ConversationDetail-header ConversationDetail-header--{{conversation.css_text_palette}}">
            <h1>{{ _('Comments') }}</h1>
        </div>
        <div class="Comment">
            <div class="CommentCard CommentCard--{{conversation.css_palette}}">
                {% if comment %}
                    {{ comment|role('card') }}
                {% else %}
                        <h1>{{ _('Congratulations!') }}</h1>
                        <p>{{ _("There are no comments left to vote :)") }}</p>
                         <p>
                            {# FIXME Add a less hardcoded pluralization  #}
                            {{ _("You have {} comment{} under moderation.").format(comments_under_moderation, "" if comments_under_moderation == 1 else "s")}}
                            {% if comments_under_moderation > 0 %}
                                {{ link(_('Click here'), href='/profile/') }}
                                {{ _("to see {}.").format("it" if comments_under_moderation == 1 else "them") }}
                            {% endif %}
                        </p>
                {% endif %}
            </div>

            {# Post a new comment #}
            {{ conversation|role('comment-form', comment_content=comment_form) }}
        </div>
        <div class="Comment-create Comment-create--{{conversation.css_text_palette}}">
            <p>
                <button onclick="showForm($(this))" id="button-create">
                    <i class="fas fa-plus"></i> {{ _("CREATE COMMENT") }}
                </button>
            </p>

            <p>{{ _("{}/{} comment{}.").format(comments_made, max_comments if can_comment else 0, "" if max_comments == 1 else "s")}}</p>
            <p>{{ _("{} waiting moderation.").format(comments_under_moderation)}}</p>
        </div>
    </div>

<script>
  $(document).ready(function() {
    var url_params = location.search.split('&');
    if (url_params.length > 1) {
      var vote_value = '';
      var comment_id = '';
      for (index in url_params) {
        var param = url_params[index];
        _param = param.split('=');
        if (/^.*vote.*$/.test(_param[0])) {
          vote_value = _param[1];
        }

        if (/^.*comment_id.*$/.test(_param[0])) {
          comment_id = _param[1];
        }
      }
      var is_unlogged = document.querySelector(".Header-lowerNotLogged");
      var is_logged = !is_unlogged;
      if (is_logged) {
        var voteClass = vote_value[0].toUpperCase() + vote_value.substring(1,vote_value.length);
        var element = document.querySelector(`.vote${voteClass} button`);
        setTimeout(function() {
          element.click();
        }, 1000);
      }
      else {
        if (vote_value && comment_id) {
          localStorage.setItem('vote', vote_value);
          localStorage.setItem('comment_id', comment_id);
        }
      }
    }
    else {
      vote_value = localStorage.getItem("vote");
      comment_id = localStorage.getItem("comment_id");
      if (vote_value && comment_id) {
        location.search = `?vote=${vote_value}&&comment_id=${comment_id}`;
        localStorage.clear();
      }
    }
  });
</script>
{% endblock %}

